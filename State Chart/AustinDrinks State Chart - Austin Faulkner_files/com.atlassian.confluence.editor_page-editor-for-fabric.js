WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.editor:page-editor-for-fabric', location = 'editor/page-editor.js' */
define("confluence-editor/editor/page-editor","ajs jquery document window confluence/meta confluence/api/constants confluence-editor/editor/page-editor-message confluence/analytics-support confluence/legacy-editor-global-AVOID-IF-POSSIBLE confluence/get-content-id confluence/api/event".split(" "),function(e,b,j,p,f,x,k,Q,c,y,h){function z(){return f.get("content-type")==="page"||f.get("content-type")==="blogpost"}function A(a){b("#editpageform").find("input[name='atl_token']").val(a);f.set("atl-token",
a);f.set("atlassian-token",a);b("#atlassian-token").attr("content",a)}var m=[],l=[],n=[],B=false,q,C=function(a){c.UI.setButtonState(a,c.UI.saveButton);c.UI.setButtonState(a,c.UI.previewButton);c.UI.setButtonState(a,c.UI.cancelButton)},r=function(a){var a=a||{},b=a.messageKey||"editor-error-message",d=a.message||"Something went wrong with the editor. Copy your unsaved changes and refresh the page to keep editing.";k.handleMessage(b,{title:a.title,type:"error",message:d},function(){a.disablePublish&&C(false)})},D=function(){h.trigger("analytics",{name:"confluence.editor.update",
data:{contentId:f.get("content-id"),notifiedWatchers:b("#notifyWatchers").is(":checked"),addedVersionComment:b("#versionComment").val()!=null&&b("#versionComment").val().length>0,contentType:f.get("content-type"),isTitleChanged:f.get("latest-published-page-title")!==b("#content-title").val(),spaceKey:f.get("space-key"),isNeverPublished:f.get("page-id")==="0"}})},N=function(a){var b=true;k.closeMessages(["offline-before-save-error"]);for(var d=0;d<l.length;d++){l[d](a)===false&&(b=false);if(a.isImmediatePropagationStopped())break}if(!b||
a.isDefaultPrevented()||a.isPropagationStopped())return false;a.preventDefault();E(a).done(function(a){a=F(a);if(a==null){e.warn("Expected deferred object not returned by save handler");D()}else a.done(D)}).fail(M)},M=function(a){var b=a||{};r({messageKey:b.messageKey||"offline-before-save-error",message:b.disablePublish?"Something went wrong with the editor. Copy your unsaved changes and refresh the page to keep editing.":"Unable to communicate with server. Saving is not possible at the moment.",disablePublish:b.disablePublish});a&&h.trigger("analytics",{name:"editor.save.error."+
a.origin+"."+a.cause});c.UI.toggleSavebarBusy(false);c.Drafts.bindUnloadMessage()},E=function(a){var i=b.Deferred();i.resolve(a);return i.promise()},F=function(){b(c.getCurrentForm()).submit()};h.bind("rte-ready",function(){c.UI.saveButton.bind("click",N)});h.bind("editor.error.message",function(a,b){r(b)});h.bind("dismiss.editor.error.message",function(a,b){k.closeMessages([b.messageKey]);b.enablePublish&&C(true)});var O=function(){var a;for(a=0;a<m.length;a++)c.UI.cancelButton.click(m[a]);var i=
b(c.getCurrentForm());for(a=0;a<n.length;a++)i.submit(n[a]);b.unbind("init.rte",this)},G=function(a,c,d,o){o.push(d);if(e.Rte&&e.Rte.BootstrapManager&&e.Rte.BootstrapManager.isInitComplete())a.bind(c,d);else if(!B){B=true;b.bind("init.rte",O)}},t=function(a,b,d){var c=null;e.Rte&&(e.Rte.BootstrapManager&&e.Rte.BootstrapManager.isInitComplete())&&(c=function(a,b,c){a.unbind(b,c)});for(var f=d.pop();f;){c&&c(a,b,f);f=d.pop()}},H=function(a){if(g!==a){g&&g.clear();a.start(c.heartbeat);g=a}},g,I=f.getNumber("heartbeat-interval")||
6E4,u,J;u={start:function(a){e.debug("Changing heartbeat to the normal scheduler");J=setInterval(a,I)},clear:function(){clearInterval(J)}};var K,L=Math.max(I/5,5E3),v,w;K={start:function(a){e.debug("Changing heartbeat to the recovery scheduler");w=0;var b=function(){a();var c=L*Math.pow(2,w);v=setTimeout(b,Math.min(c,3E5));w++};v=setTimeout(b,L)},clear:function(){clearTimeout(v)}};return{bookmark:"",MODE_RICHTEXT:"richtext",MODE_SOURCE:"source",MODE_PREVIEW:"preview",PREVIEW_OUTPUT_TYPE:"PREVIEW",
currentEditMode:null,contentHasChangedSinceLastSave:false,sourceInitialValue:false,isSubmitting:false,isCancelling:false,overrideBeforeSave:function(a){E=a},overrideSave:function(a){F=a},addCancelHandler:function(a){G(c.UI.cancelButton,"click",a,m)},addSaveHandler:function(a){l.push(a)},addSubmitHandler:function(a){G(b(c.getCurrentForm()),"submit",a,n)},removeAllCancelHandlers:function(){t(c.UI.cancelButton,"click",m)},removeAllSaveHandlers:function(){t(c.UI.saveButton,"click",l)},removeAllSubmitHandlers:function(){t(b(c.getCurrentForm()),
"submit",n)},hasContentChanged:function(){return!this.inRichTextMode()&&!this.contentHasChangedSinceLastSave?false:this.editorHasContentChanged()},editorHasContentChanged:function(){if(e.Rte.getEditor()==null){e.debug("Editor: editorHasContentChanged - No active editor present. Returning false.");return false}return e.Rte.Content.editorHasContentChanged()},isEmpty:function(){var a=b(e.Rte.getEditor().getContent()).text();return!b.trim(a)},getCurrentTitle:function(){return b("#content-title")&&b("#content-title").val()},
contentFormSubmit:function(){b(".editable-title #content-title").prop("disabled",true);return true},metadataSyncRequired:z,heartbeat:function(a){var a=a||{},i={dataType:"json",contentId:f.get("content-id"),draftType:f.get("content-type"),contributorsHash:f.get("contributors-hash"),collabService:"synchrony",editorVersion:"v1"};q=e.safe.ajax({url:x.CONTEXT_PATH+"/json/startheartbeatactivity.action",type:"POST",data:i,dataType:"json",async:a.synchronousHeartbeat!==true}).done(function(d){if(!z()&&d){A(d.atlToken);
h.trigger("rte.heartbeat",d)}else if(!d||!d.atlToken){if(d.status==="unauthorised")if(a.movedBy){k.closeMessages(["heartbeat-error"]);k.handleMessage("heartbeat-error",{type:"error",title:"Page permissions have changed",message:"You can\'t publish due to a page move or change in restrictions. You will be redirected in 10 seconds."})}else{k.closeMessages(["heartbeat-error"]);k.handleMessage("heartbeat-error",{type:"error",title:"No access to this page",
message:"This content has been moved, restricted, or deleted. You will be redirected in 10 seconds."})}h.trigger("rte.heartbeat-error","Invalid server response");e.logError("Unexpected server response for heartbeat:");e.log(d);setTimeout(function(){var a=f.get("base-url")+"/pages/viewpage.action?pageId="+f.get("content-id");p.location=a},1E4)}else{f.set("contributors-hash",d.contributorsHash);A(d.atlToken);c.heartbeatType.normal();h.trigger("rte.heartbeat",d);b(j).trigger("resize.resizeplugin");h.trigger("editor-heartbeat",
d)}}).fail(function(a,b,i){(a.status>=500||a.status===0)&&c.heartbeatType.recovery();if(a.status===403||a.status===401)e.logError("Heartbeat error: Unauthorized");else{e.logError("Server error on heartbeat request:");e.log(i)}h.trigger("rte.heartbeat-error",a)})},heartbeatType:{normal:function(){H(u)},recovery:function(){H(K)},reset:function(){g&&g.clear();g=u;g.start(c.heartbeat)},cleanup:function(){if(g){g.clear();g=null}q&&q.abort&&q.abort()}},disableFrame:function(a){b("form",a).each(function(){b(this).unbind();
this.onsubmit=function(){return false}});b("a",a).each(function(){b(this).attr("target","_top").unbind()});b("input, img",a).each(function(){b(this).unbind()})},previewFrameOnload:function(a,i){var d=require("tinymce");c.setMode(c.MODE_PREVIEW);d.activeEditor.setProgressState(false);c.disableFrame(a);var o=b("#main",a)[0];if(f.get("content-type")!=="comment"&&b(o).find("#main-header").length===0){var h=b("#title-heading"),g=h.attr("class");b(o).prepend('<div id="preview-header"><div id="title-heading" class="'+
g+'">'+h.html()+"</div></div>")}if(b(e.Rte.getEditor().getBody()).hasClass("resizable")){var s=b(i||"#previewArea iframe"),k=0,m=0,l,n=s.height();o&&function P(){var a=b(o).outerHeight(true);if(k!==a){a!==s.height()&&s.height(0).height(Math.max(a,n));k=a;m=0}else m++;m<500&&(l=setTimeout(P,500))}();b(j).one("mode-changed.resize-editor",function(a,b){b!==c.MODE_PREVIEW&&l&&clearTimeout(l)})}else if(d.isIE||d.isOpera){d=b(p).height();h=b("#header-precursor").height()+b("#header").height()+b("#editor-precursor").height();
g=b("#savebar-container").height();b("#preview iframe").height(d-h-g-4);b("#content.edit").height("auto")}},showRichText:function(a){var i=require("tinymce");e.setVisible("#wysiwyg",a);b(".toolbar-group-edit").toggleClass("assistive",a);b(".toolbar-group-preview").toggleClass("assistive",!a);b("#main").toggleClass("active-richtext",a);i.isGecko&&a&&e.Rte.fixEditorFocus(c.bookmark)},showPreview:function(a){if(f.get("content-type")!=="comment"){var c=b("#content-title");if(c.hasClass("placeholded")){b("#preview-title-text").text("");
b("#title-text").text("")}else{b("#preview-title-text").text(c.val());b("#title-text").text(c.val())}}e.setVisible("#preview",a);b(".toolbar-group-preview").toggleClass("assistive",a);b(".toolbar-group-edit").toggleClass("assistive",!a);b("#main, .editor-container").toggleClass("active-preview",a);f.get("content-type")!=="comment"&&b("#full-height-container").length&&b("#full-height-container").toggleClass("active-preview",a)},showSource:function(a){a?this.showSourceArea():this.hideSourceArea();b("#main")[a?
"addClass":"removeClass"]("active-source")},setMode:function(a){e.debug("Set mode: "+a);if(a===c.MODE_RICHTEXT){this.showRichText(true);this.showPreview(false);this.showSource(false)}else if(a===c.MODE_SOURCE){this.showSource(true);this.showRichText(false);this.showPreview(false)}else if(a===c.MODE_PREVIEW){this.showPreview(true);this.showRichText(false);this.showSource(false);c.UI.spinner.removeClass("aui-icon-wait")}setTimeout(function(){var a=b(".toolbar-group-preview");a.height(0);a.height();
a.height("auto");a.height("")},1);this.currentEditMode=a;b(j).trigger("mode-changed",[a])},getContentId:function(){return y()},addErrorMessage:function(a,c,d){var f=b("#"+a),d=d?"#all-messages":"#editor-messages";f.length?f.empty():f=b("<div></div>").attr("id",a).appendTo(d);e.messages.error(f,{closeable:true,body:c})},changeMode:function(a,i){var d=require("tinymce");e.debug("Change mode: "+a);i=i||{};if(this.inRichTextMode()&&!e.Rte.BootstrapManager.isInitComplete()||this.currentEditMode===a)return false;
var g=this.currentEditMode;h.trigger("rte-changeMode",a);if(a===c.MODE_PREVIEW){var m=e.Rte.getEditor();g===c.MODE_SOURCE&&c.transferSourceToEditor();if(d.isGecko&&g===c.MODE_RICHTEXT&&!c.bookmark)c.bookmark=d.activeEditor.selection.getBookmark();this.currentEditMode=a;d=function(a){typeof a!=="object"&&(a={draftId:y()});a={contentId:a.draftId,contentType:f.get("content-type"),spaceKey:f.get("space-key"),xHtml:m.getContent(),outputType:c.PREVIEW_OUTPUT_TYPE};e.safe.ajax({type:"POST",url:x.CONTEXT_PATH+
"/pages/rendercontent.action",data:a,success:c.replysetPreviewArea,timeout:2E4,error:function(){h.trigger("rte.preview.error",{status:0});k.closeMessages(["server-offline"]);r({messageKey:"server-offline",message:"Can\'t reach the server. Check you\'re connected to the internet and Confluence is up and running.",disablePublish:false});c.currentEditMode=g;i.errorCallback&&i.errorCallback()}})};f.get("content-type")==="comment"?d():c.Drafts.save({forceSave:true,onSuccessHandler:d,onErrorHandler:d})}else this.setMode(a);a===c.MODE_RICHTEXT&&b(j).trigger("resize.resizeplugin");
if(g===c.MODE_PREVIEW)if(d=j.getElementById("editor-preview-iframe")){var l=d.contentDocument||d.contentWindow.document;l.removeChild(l.documentElement);b(d).remove()}return false},replysetPreviewArea:function(a){var c=require("tinymce");b("#preview-error").remove();c.activeEditor.setProgressState(true);var c=b("#previewArea"),d=b('<iframe id="editor-preview-iframe" src="about:blank" scrolling="yes" frameborder="0"></iframe>');c.html(d);c=d[0].contentDocument||d[0].contentWindow.document;c.open();
c.write(a);c.close()},inRichTextMode:function(){return this.currentEditMode===c.MODE_RICHTEXT},isNewPage:function(){return b("#createpageform, #createpagetemplate").length>0},onInit:function(){var a=require("tinymce");c.setMode(c.MODE_RICHTEXT);a.activeEditor.onClick.add(function(){var a=c.UI.postingDatePicker;a&&a.hide()})},contentChangeHandler:function(){this.contentHasChangedSinceLastSave=true},getCurrentForm:function(){return require("tinymce").activeEditor.formElement},transferSourceToEditor:function(){if(c.sourceInitialValue){var a=
c.getSourceAreaVal();if(a!==c.sourceInitialValue){var b=require("tinymce").activeEditor;b.setContent(a);b.setDirty(a)}}c.sourceInitialValue=false},hideSourceArea:function(){b("#editor-html-source-container").addClass("hidden");this.setToolBarInactive(false);this.transferSourceToEditor();b("#rte-button-source-mode").removeClass("active");b("#rte-button-publish").unbind("click.source-save")},showSourceArea:function(){var a=require("tinymce");b("#editor-html-source-container").removeClass("hidden");
this.setSourceAreaHeight();this.setToolBarInactive(true);this.sourceInitialValue=a.activeEditor.getContent();this.setSourceAreaVal(this.sourceInitialValue);b("#rte-button-source-mode").addClass("active");b("#rte-button-publish").bind("click.source-save",c.transferSourceToEditor)},getSourceAreaVal:function(){return b("#editor-html-source").val()},setSourceAreaVal:function(a){b("#editor-html-source").val(a)},setSourceAreaHeight:function(){var a=e.Rte.getTinyMceEditorMinHeight();e.debug("HTML source height= "+
a);var c=b("#editor-html-source")[0].scrollHeight;if(c>a){a=c;e.debug("ACTUAL HEIGHT "+c)}b("#editor-html-source-container").height(a+"px")},setToolBarInactive:function(a){b("#rte-toolbar").toggleClass("disabled",a)},isVisible:function(){return b("#wysiwyg:visible").length>0||b("#editor-html-source-container:visible").length>0||b("#preview:visible").length>0}}});
require("confluence/module-exporter").safeRequire("confluence-editor/editor/page-editor",function(e){var b=require("jquery"),j=require("ajs"),p=require("confluence/api/event");j.Editor=j.Editor||{};Confluence.Editor=b.extend(Confluence.Editor||{},j.Editor,e);j.toInit(function(){p.bind("init.rte",Confluence.Editor.onInit)});j.Editor=Confluence.Editor});
}catch(e){WRMCB(e)};